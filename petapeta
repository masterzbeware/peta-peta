-- ✅ Obsidian UI Setup
local repo = "https://raw.githubusercontent.com/deividcomsono/Obsidian/main/"
local Library = loadstring(game:HttpGet(repo .. "Library.lua"))()

Library.ForceCheckbox = false
Library.ShowToggleFrameInKeybinds = true

local Window = Library:CreateWindow({
    Title = "Bug Hunter",
    Footer = "by MasterZ",
    Icon = 0,
    NotifySide = "Right",
    ShowCustomCursor = true,
})

-- ✅ Tabs & GroupBox
local Tabs = {
    Main = Window:AddTab("Main", "bug"),
}

local ESPBox = Tabs.Main:AddLeftGroupbox("ESP & Coin")
local AutoBox = Tabs.Main:AddRightGroupbox("Auto Farm")

-- ✅ Warna ESP
local highlightColors = {
    Key = Color3.fromRGB(255, 223, 0),
    OfudaBox2 = Color3.fromRGB(0, 255, 255),
    Safe = Color3.fromRGB(255, 0, 0),
    Zeni = Color3.fromRGB(0, 255, 0),
}

-- ✅ Fungsi Highlight ESP
local function highlightModel(model, color)
    if not model or model:FindFirstChild("ESP_Highlight") then return end
    local hl = Instance.new("Highlight")
    hl.Name = "ESP_Highlight"
    hl.Adornee = model
    hl.FillColor = color
    hl.OutlineColor = Color3.new(1, 1, 1)
    hl.FillTransparency = 0.25
    hl.OutlineTransparency = 0
    hl.Parent = model
end

local function removeHighlight(model)
    local hl = model:FindFirstChild("ESP_Highlight")
    if hl then hl:Destroy() end
end

-- ✅ Toggle: ESP Key
ESPBox:AddToggle("ESPKey", {
    Text = "ESP Key",
    Default = false,
    Callback = function(state)
        local spawnedItems = workspace:FindFirstChild("Server") and workspace.Server:FindFirstChild("SpawnedItems")
        if not spawnedItems then return end

        for _, model in ipairs(spawnedItems:GetChildren()) do
            if model:IsA("Model") and model.Name == "Key" then
                if state then highlightModel(model, highlightColors.Key)
                else removeHighlight(model) end
            end
        end

        if not _G.ESPKeyConnection then
            _G.ESPKeyConnection = spawnedItems.ChildAdded:Connect(function(child)
                if child:IsA("Model") and child.Name == "Key" and Toggles.ESPKey.Value then
                    task.wait(0.1)
                    highlightModel(child, highlightColors.Key)
                end
            end)
        end

        if not state and _G.ESPKeyConnection then
            _G.ESPKeyConnection:Disconnect()
            _G.ESPKeyConnection = nil
        end
    end
})

-- ✅ Toggle: ESP Box
ESPBox:AddToggle("ESPBox", {
    Text = "ESP Box",
    Default = false,
    Callback = function(state)
        local spawnedItems = workspace:FindFirstChild("Server") and workspace.Server:FindFirstChild("SpawnedItems")
        if not spawnedItems then return end

        for _, model in ipairs(spawnedItems:GetChildren()) do
            if model:IsA("Model") and model.Name == "OfudaBox2" then
                if state then highlightModel(model, highlightColors.OfudaBox2)
                else removeHighlight(model) end
            end
        end

        if not _G.ESPBoxConnection then
            _G.ESPBoxConnection = spawnedItems.ChildAdded:Connect(function(child)
                if child:IsA("Model") and child.Name == "OfudaBox2" and Toggles.ESPBox.Value then
                    task.wait(0.1)
                    highlightModel(child, highlightColors.OfudaBox2)
                end
            end)
        end

        if not state and _G.ESPBoxConnection then
            _G.ESPBoxConnection:Disconnect()
            _G.ESPBoxConnection = nil
        end
    end
})

-- ✅ Toggle: ESP Safe
ESPBox:AddToggle("ESPSafe", {
    Text = "ESP Safe",
    Default = false,
    Callback = function(state)
        local roomsFolder = workspace:FindFirstChild("Client")
            and workspace.Client:FindFirstChild("Mirror")
            and workspace.Client.Mirror:FindFirstChild("Rooms")
        if not roomsFolder then return end

        for _, room in ipairs(roomsFolder:GetChildren()) do
            local props = room:FindFirstChild("Props")
            if props then
                for _, item in ipairs(props:GetChildren()) do
                    if item:IsA("Model") and item.Name == "Safe" then
                        if state then highlightModel(item, highlightColors.Safe)
                        else removeHighlight(item) end
                    end
                end
            end
        end

        if not _G.SafeConnection then
            _G.SafeConnection = roomsFolder.ChildAdded:Connect(function(room)
                task.wait(0.2)
                if Toggles.ESPSafe.Value and room:IsA("Model") then
                    local props = room:FindFirstChild("Props")
                    if props then
                        for _, item in ipairs(props:GetChildren()) do
                            if item:IsA("Model") and item.Name == "Safe" then
                                highlightModel(item, highlightColors.Safe)
                            end
                        end
                    end
                end
            end)
        end

        if not state and _G.SafeConnection then
            _G.SafeConnection:Disconnect()
            _G.SafeConnection = nil
        end
    end
})

-- ✅ Toggle: ESP Coin
ESPBox:AddToggle("ESPCoin", {
    Text = "ESP Coin",
    Default = false,
    Callback = function(state)
        local spawnedItems = workspace:WaitForChild("Server"):WaitForChild("SpawnedItems")
        for _, model in ipairs(spawnedItems:GetChildren()) do
            if model:IsA("Model") and model.Name:match("Zeni_") then
                if state then highlightModel(model, highlightColors.Zeni)
                else removeHighlight(model) end
            end
        end
    end
})

-- ✅ Toggle: Auto Collect Coin (Server Only)
ESPBox:AddToggle("AutoCoin", {
    Text = "Auto Collect Coin (Server)",
    Default = false,
    Callback = function(state)
        if state then
            if not _G.CoinLoop then
                _G.CoinLoop = true
                task.spawn(function()
                    local spawnedItems = workspace:WaitForChild("Server"):WaitForChild("SpawnedItems")
                    while _G.CoinLoop and task.wait(1) do
                        for _, model in ipairs(spawnedItems:GetChildren()) do
                            if model:IsA("Model") and model.Name:match("Zeni_") then
                                local ip = model:FindFirstChild("InteractPoint")
                                local prompt = ip and ip:FindFirstChildOfClass("ProximityPrompt")
                                if prompt then
                                    game.Players.LocalPlayer.Character:PivotTo(model:GetPivot())
                                    task.wait(0.2)
                                    fireproximityprompt(prompt)
                                end
                            end
                        end
                    end
                end)
            end
        else
            _G.CoinLoop = false
        end
    end
})

-- ✅ Toggle: Auto Collect Coin (Room Props)
AutoBox:AddToggle("AutoRoomZeni", {
    Text = "Auto Room Coin",
    Default = false,
    Callback = function(state)
        if state then
            if not _G.RoomZeniLoop then
                _G.RoomZeniLoop = true
                task.spawn(function()
                    local roomsFolder = workspace:FindFirstChild("Client") and workspace.Client:FindFirstChild("Mirror") and workspace.Client.Mirror:FindFirstChild("Rooms")
                    local player = game.Players.LocalPlayer
                    local char = player.Character or player.CharacterAdded:Wait()

                    while _G.RoomZeniLoop and task.wait(1.5) do
                        if not roomsFolder then continue end

                        for _, room in ipairs(roomsFolder:GetChildren()) do
                            local props = room:FindFirstChild("Props")
                            if not props then continue end

                            local shelf = props:FindFirstChild("Shelf")
                            if not shelf then continue end

                            for i = 1, 3 do
                                local tana = shelf:FindFirstChild("tana"..i)
                                if not tana then continue end

                                for _, zeniModel in ipairs(tana:GetChildren()) do
                                    if zeniModel:IsA("Model") and zeniModel.Name:match("Zeni_") then
                                        local interactPoint = zeniModel:FindFirstChild("InteractPoint")
                                        local prompt = interactPoint and interactPoint:FindFirstChild("ItemInteractP")

                                        if prompt and char:FindFirstChild("HumanoidRootPart") then
                                            char:PivotTo(zeniModel:GetPivot())
                                            task.wait(0.2)
                                            fireproximityprompt(prompt)
                                            task.wait(0.5)
                                        end
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        else
            _G.RoomZeniLoop = false
        end
    end
})

-- ✅ Toggle: Auto Farm (Key > Box > Ofuda)
AutoBox:AddToggle("AutoFarm", {
    Text = "Auto Farm",
    Default = false,
    Callback = function(state)
        if state then
            if not _G.AutoFarmLoop then
                _G.AutoFarmLoop = true
                task.spawn(function()
                    local player = game.Players.LocalPlayer
                    local char = player.Character or player.CharacterAdded:Wait()
                    local rs = game:GetService("ReplicatedStorage")
                    local serverItems = workspace:WaitForChild("Server"):WaitForChild("SpawnedItems")

                    while _G.AutoFarmLoop and task.wait(1.5) do
                        -- Step 1: Key
                        local keyModel
                        for _, item in ipairs(serverItems:GetChildren()) do
                            if item:IsA("Model") and item.Name == "Key" then
                                keyModel = item
                                break
                            end
                        end

                        if keyModel then
                            local ip = keyModel:FindFirstChild("InteractPoint")
                            local prompt = ip and ip:FindFirstChild("ItemInteractP")
                            if prompt and char:FindFirstChild("HumanoidRootPart") then
                                char:PivotTo(keyModel:GetPivot())
                                task.wait(0.3)
                                fireproximityprompt(prompt)
                                task.wait(0.3)

                                -- Equip Key
                                local args = {"Equip", "Key"}
                                rs:WaitForChild("ToolBarEvent"):FireServer(unpack(args))
                                task.wait(0.3)
                            end
                        end

                        -- Step 2: OfudaBox2
                        local boxModel
                        for _, item in ipairs(serverItems:GetChildren()) do
                            if item:IsA("Model") and item.Name == "OfudaBox2" then
                                boxModel = item
                                break
                            end
                        end

                        if boxModel then
                            local ip = boxModel:FindFirstChild("InteractPoint")
                            local prompt = ip and ip:FindFirstChild("ItemInteractP")
                            if prompt and char:FindFirstChild("HumanoidRootPart") then
                                char:PivotTo(boxModel:GetPivot())
                                task.wait(0.3)
                                fireproximityprompt(prompt)
                                task.wait(0.5)
                            end
                        end

                        -- Step 3: Wait Ofuda
                        local ofudaModel
                        local waitTime = 5
                        while waitTime > 0 and not ofudaModel do
                            for _, item in ipairs(serverItems:GetChildren()) do
                                if item:IsA("Model") and item.Name == "Ofuda" then
                                    ofudaModel = item
                                    break
                                end
                            end
                            waitTime -= 0.5
                            task.wait(0.5)
                        end

                        if ofudaModel then
                            local handle = ofudaModel:FindFirstChild("Handle")
                            local prompt = handle and handle:FindFirstChild("ItemInteractP")
                            if prompt and char:FindFirstChild("HumanoidRootPart") then
                                char:PivotTo(ofudaModel:GetPivot())
                                task.wait(0.3)
                                fireproximityprompt(prompt)
                                task.wait(0.3)
                            end
                        end
                    end
                end)
            end
        else
            _G.AutoFarmLoop = false
        end
    end
})
